---
title: "Input properties"
author: "O. Denas"
date: "9/29/2017"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


#Input properties
```{r, echo=FALSE, message=FALSE}
library(tidyverse)
rm(list = ls())

ddir <- '../input_stats_data/exploration/datasets/data_dir/'
all_data <- (do.call(rbind, lapply(list.files(ddir, pattern = '*.csv'), function(fname){
  read.csv(sprintf("%s/%s", ddir, fname)) %>% mutate(b_path = strsplit(fname, split = ".", fixed = TRUE)[[1]][1])
  })) %>% separate(b_path, into=c('stype', 'slen', 'ttype', 'tlen', 'alp', 'rep_mut', 'sim_mut')) %>% 
    unite(col = inp_type, stype, ttype, sep = "_")
)

node_data <- (all_data %>% 
                filter(measuring == "wl_calls", where == "ms") %>% 
                separate(key, into=c('char', 'maxrep', 'has_wl', 'wide_i')) %>%
                #mutate(wide_i=(wide_i == "wide"),maxrep=(maxrep == "m1"), has_wl=(has_wl=="wl")) %>% 
                select(alp, wide_i, char, has_wl, maxrep, inp_type, rep_mut, sim_mut, value))
#node_data

pdata <- (all_data %>% 
            filter(measuring == "pseq", where == "ms") %>% 
            mutate(key = as.numeric(key), rep_mut=as.numeric(rep_mut), sim_mut=as.numeric(sim_mut)) %>% 
            #group_by(inp_type, alp, rep_mut, sim_mut, key) %>% summarise(value = sum(value)) %>% ungroup() %>% 
            select(inp_type, alp, key, rep_mut, sim_mut, value))
#pdata$key
#pdata %>% group_by(alp, rep_mut, sim_mut) %>% summarise(value = sum(value)) %>% ungroup() %>% filter(alp=='abcde', rep_mut==1, sim_mut==1)


wldata <- (all_data %>% 
             filter(measuring == "wlseq", where == "ms") %>% 
             mutate(key = as.numeric(key), sim_mut=as.numeric(sim_mut), rep_mut=as.numeric(rep_mut)) %>% 
             select(inp_type, alp, key, rep_mut, sim_mut, value))
#wldata
```

Experiments are performed on the following inputs:

```{r, echo=FALSE}
library(knitr)
kable(tibble(path = list.files("../input_stats_data/exploration/datasets/data_dir", pattern = "*.s$")) %>% 
        separate(path, into = c("s_type", "sl", "t_type", "tl", "alp", "rep_mut", "sim_mut", "suff")) %>% 
        separate(sl, into=c('slen', 'ssuff'), sep="s") %>% 
        separate(tl, into=c('tlen', 'tsuff'), sep="t") %>% 
        select(s_type, t_type, slen, tlen, alp, rep_mut, sim_mut) %>% 
        mutate(slen = as.numeric(slen), tlen = as.numeric(tlen), alp=str_length(alp),
               num_blocks=1000, block_len = slen / num_blocks, 
               s_mutation_rate = as.numeric(rep_mut) / block_len, t_mutation_rate = as.numeric(sim_mut) / tlen) %>% 
        select(-s_type, -t_type), 
  caption = "Input datasets", 
  format.args = list(decimal.mark = ",", big.mark = "'", scientific=FALSE))
```

The index (aka $S$) is generated by the concatenation of $(s_1, \ldots, s_k)$ where  $\sum_i |s_i| = |S|$. The query (aka $T$) is generated by mutating $S[1..|T|]$.

Description of columns:

 * slen/tlen: length of the index/query string. I.e., $|S|$ and $|T|$.
 * alp: the alphabet length 
 * rep_mut: number of mutations introduced to block $s_1$ to obtain blocks $s_i$ with $1 < i \leq k$.
 * sim_mut: number of mutations introduced to $S[1..|T|]$ in order to obtain $T$ -- I.e., $T$ differs from $S$ by `sim_mut` characters.
 * num_blocks: number of blocks to obtain $S$ ($k$ above).
 * block_len: length of $s_i$ for $1\leq i\leq n$
 * s_mutation_rate: `sim_mut` / `block_len` 
 * t_mutation_rate:  `sim_mut` / `tlen`

Notice that the row with `rep_mut=rep_sim=1` has `S` that is a almost a perfect repeat of blocks, and `T` almost a perfect copy of it. 

On the other hand, `rep_mut=block_len` and `rep_sim=` $|T|$ has `S` pretty much random (since we are  mutating all chars of a block) and `T` having mismatches everywhere.

## Node properties
Before making a `wl(v, c)` call register whether `v` is a maximal repeat, and whether the Weiner link exists or not. 

```{r, echo=FALSE, fig.height=8}

ndt <- node_data %>% group_by(alp, has_wl, maxrep, rep_mut, sim_mut) %>% 
  summarise(value = sum(value, na.rm = TRUE)) %>% 
  unite(node_type, maxrep, has_wl)

ggplot(ndt, aes(node_type, value, fill=factor(sim_mut))) + 
  geom_bar(stat="identity", position="dodge") + 
  facet_grid(rep_mut~alp, labeller = labeller(rep_mut = function(d) sprintf("rep_mut = %s", d))) + 
  labs(title = "(counts of) types of nodes visited during MS construction") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + scale_y_log10()
```

## Consecutive wl() calls
During the MS vector construction, count the number of consecutive wl() calls due to matches between reversed indexed string and the query. In other words count the $k$-length iterations of the while cycle.

```{r, echo=FALSE}
xl <- "Nr. of consecutive wl calls"

#ggplot(wldata %>% filter(alp == 'abcde'), aes(as.numeric(key), value, group=alp)) + geom_point() + facet_grid(rep_mut~sim_mut, labeller = labeller(rep_mut = function(d) sprintf("rep_mut = %s", d), sim_mut = function(d) sprintf("sim_mut = %s", d)), scales = "free_y") + labs(x = xl, y = "Count", title="Small alphabet")

#ggplot(wldata %>% filter(alp != 'abcde'), aes(as.numeric(key), value, group=alp)) + geom_point() + facet_grid(rep_mut~sim_mut, labeller = labeller(rep_mut = function(d) sprintf("rep_mut = %s", d), sim_mut = function(d) sprintf("sim_mut = %s", d)), scales = "free_y") + labs(x = xl, y = "Count", title="Big alphabet")

#ggplot(wldata %>% filter(rep_mut==1), aes(factor(as.numeric(key)), value, group=factor(sim_mut), color=factor(sim_mut))) + geom_point() + geom_line(alpha=0.2) + facet_wrap(~alp, ncol = 1) + scale_y_log10() + labs(title = 'rep_mut = 1', x=xl)

#ggplot(wldata %>% filter(rep_mut==10), aes(factor(as.numeric(key)), value, group=factor(sim_mut), color=factor(sim_mut))) + geom_point() + geom_line(alpha=0.2) + facet_wrap(~alp, ncol = 1) + scale_y_log10() + labs(title = 'rep_mut = 10', x=xl)

#ggplot(wldata %>% filter(rep_mut==100), aes(factor(as.numeric(key)), value, group=factor(sim_mut), color=factor(sim_mut))) + geom_point() + geom_line(alpha=0.2) + facet_wrap(~alp, ncol = 1) + scale_y_log10() + labs(title = 'rep_mut = 100', x=xl)


for(i in c(1, 100, 100)){
  print(ggplot(wldata %>% filter(rep_mut==i), aes(key, value, group=sim_mut, color=factor(sim_mut))) + 
    geom_point() + geom_line(alpha=0.8) + 
    facet_wrap(~alp, ncol = 1, scales="free") + scale_y_log10() +
    labs(title = sprintf('rep_mut = %d', i), x=xl, y="log10(count)"))
}

```

## Consecutive parent() calls
During the MS vector construction, count the number of consecutive `parent()` calls after a failed `wl()` call.

```{r, echo=FALSE}
xl <- "Nr. of consecutive parent calls"

#ggplot(pdata %>% filter(alp == 'abcde'), aes(as.numeric(key), value, group=alp)) + geom_point() + facet_grid(rep_mut~sim_mut, labeller = labeller(rep_mut = function(d) sprintf("rep_mut = %s", d), sim_mut = function(d) sprintf("sim_mut = %s", d)), scales = "free_y") + labs(x = xl, y = "Count", title="Small alphabet")

#ggplot(wldata %>% filter(alp != 'abcde'), aes(as.numeric(key), value, group=alp)) + geom_point() + facet_grid(rep_mut~sim_mut, labeller = labeller(rep_mut = function(d) sprintf("rep_mut = %s", d), sim_mut = function(d) sprintf("sim_mut = %s", d)), scales = "free_y") + labs(x = xl, y = "Count", title="Big alphabet")


#ggplot(pdata %>% filter(rep_mut==1), aes(factor(as.numeric(key)), value, group=factor(sim_mut), color=factor(sim_mut))) + geom_point() + geom_line(alpha=0.2) + facet_wrap(~alp, ncol = 1) + scale_y_log10() + labs(title = 'rep_mut = 1', x=xl)

#ggplot(pdata %>% filter(rep_mut==10), aes(factor(as.numeric(key)), value, group=factor(sim_mut), color=factor(sim_mut))) + geom_point() + geom_line(alpha=0.2) + facet_wrap(~alp, ncol = 1) + scale_y_log10() + labs(title = 'rep_mut = 10', x=xl)

#ggplot(pdata %>% filter(rep_mut==100), aes(factor(as.numeric(key)), value, group=factor(sim_mut), color=factor(sim_mut))) + geom_point() + geom_line(alpha=0.2) + facet_wrap(~alp, ncol = 1) + scale_y_log10() + labs(title = 'rep_mut = 100', x=xl)

for(i in c(1, 10, 100)){
  plot(ggplot(pdata %>% filter(rep_mut==i), aes(as.numeric(key), value, group=sim_mut, color=factor(sim_mut))) + 
         geom_point() + geom_line(alpha=0.8) +
         facet_wrap(~alp, ncol=1, scales="free") + scale_y_log10() +
         labs(title = sprintf('rep_mut = %d', i), x=xl, y="log10(count)"))
}
```
