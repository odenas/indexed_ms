---
title: "range_report"
author: "odenas"
date: "August 14, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Range queries on block compression 
```{r}
library(tidyverse)
rm(list=ls())

rel_diff <- function(a, b) a / b
fname <- "./block_compression/ms_data/sizes.csv"

aa <- (
  read_csv(fname, col_names=c("exp_type", "size"))
  %>% separate(exp_type, c("block_type", "bt", "start", "end_"), sep = "_")
  %>% separate(end_, c("end", "compr"), extra="merge")
  %>% mutate(start=as.numeric(start), end=as.numeric(end))
)
aa


ggplot(aa, aes(start, size, color=compr)) + geom_line()

```

# Range queries on vanilla compression 
```{r}
library(tidyverse)
rm(list=ls())

rel_diff_f <- function(a, b) (a - b) / pmax(a, b)
base_dir <- "./vanilla_compression_techniques/max"

read_time_dataset <- function(input_id){
  time_dd <- (
    read_csv(sprintf("%s/%s.t.ms.csv", base_dir, input_id))
    %>% filter(method %in% c('algorithm'))
    %>% mutate(time_ms = time_ms / nqueries, 
               method=case_when(block_size <= 0 ~ 'noindex', TRUE ~ 'indexed'),
               dset=input_id) 
    %>% select(-nqueries, -range_size)
  )
  time_dd
}


dd <- (
  rbind(read_time_dataset('HG03061-2'), read_time_dataset('mm'))
  %>% spread(algo, time_ms)
  %>% mutate(rel_diff = rel_diff_f(d, t), abs_diff = (d - t), speedup=t/d)
  %>% select(dset, compression, block_size, method, d, t, rel_diff, abs_diff, speedup)
)
dd %>% arrange(dset, compression, method)
```

none 1    < 4
none 1.73 < 4.75
none 2.14 < 6.29
rrr  6.50 > 4.38
rrr  8.16 > 5.47
rrr  15.9 > 12.5

```{r}
base_dir <- "./vanilla_compression_techniques"
read_sizes_dataset <- function(input_id){
  get_size <- function(e){
    file.info(sprintf('%s/%s.t.ms.%s', base_dir, input_id, e))$size
  }
  space_dd <- (
    tibble(compression = c('delta', 'nibble', 'none', 'rle', 'rrr', 'succint'))
    %>% mutate(size = sapply(compression, get_size))
  )
  
  space_dd <- rbind(space_dd, space_dd %>% filter(compression == 'none') %>% mutate(compression = 'word'))

  space_dd <- (
    space_dd %>% mutate(gr = 1)
    %>% inner_join(
      space_dd %>% filter(compression == "none") %>% transmute(gr = 1, nsize=size),
      by=c("gr"))
    %>% mutate(size_diff = rel_diff_f(size, nsize))
    %>% select(-gr)
  )
  space_dd  
}

space_dd <- rbind(read_sizes_dataset('HG03061-2') %>% mutate(dset='human_human'),
                  read_sizes_dataset('mm') %>% mutate(dset='chimp_human'))
space_dd
```


# Junk
```{r}
library(tidyverse)
ddf <- tribble(
  ~method, ~time_ms, 
  'numpy_1hot', 1.9, 
  'cuda_1hot', 0.25,
  'cuda_dense', 0.89
) %>% mutate(speedup = 122 / time_ms)
ddf

ggplot(ddf, aes(method, speedup)) + geom_bar(stat='identity', position = 'dodge') + labs(y = 'Speedup', subtitle = "Speedup over 'numpy_dense'")
  ```